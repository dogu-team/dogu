name: ðŸš€release-gcp
run-name: ðŸš€release-gcp-${{github.event.inputs.run_type}}-${{github.event.inputs.project_type}}@${{github.ref_name}}

on:
  workflow_dispatch:
    inputs:
      run_type:
        type: choice
        description: Select run type
        options:
          - development
          - production

      project_type:
        type: choice
        description: Select project type
        options:
          - console-web-front
          - console-web-server

permissions:
  id-token: write
  contents: read

env:
  DOGU_GCP_REGION: asia-northeast3

jobs:
  parse-inputs:
    runs-on: henry-macbook

    # set from parse-inputs
    outputs:
      GCP_SA_KEY_BASE64: ${{steps.parse-inputs.outputs.GCP_SA_KEY_BASE64}}
      GCP_PRIVATE_SSH_KEY_BASE64: ${{steps.parse-inputs.outputs.GCP_PRIVATE_SSH_KEY_BASE64}}
      DOCKER_TAG_BASE64: ${{steps.parse-inputs.outputs.DOCKER_TAG_BASE64}}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          sparse-checkout: scripts/release
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 16

      - id: parse-inputs
        name: Parse inputs
        run: node scripts/release/gcp.mjs parse-inputs
        env:
          DEV_DOCKER_TAG: asia-northeast3-docker.pkg.dev/${{secrets.GCP_DEV_PROJECT_ID}}/projects/${{github.event.inputs.project_type}}:${{github.ref_name}}
          PROD_DOCKER_TAG: asia-northeast3-docker.pkg.dev/${{secrets.GCP_PROD_PROJECT_ID}}/projects/${{github.event.inputs.project_type}}:${{github.ref_name}}
          GCP_DEV_CICD_SA_KEY: ${{secrets.GCP_DEV_CICD_SA_KEY}}
          GCP_PROD_CICD_SA_KEY: 'NEED_TO_SET'
          GCP_DEV_PRIVATE_SSH_KEY: ${{secrets.GCP_DEV_PRIVATE_SSH_KEY}}
          GCP_PROD_PRIVATE_SSH_KEY: 'NEED_TO_SET'
          DOGU_RUN_TYPE: ${{github.event.inputs.run_type}}
          DOGU_PROJECT_TYPE: ${{github.event.inputs.project_type}}

  publish:
    needs: parse-inputs
    runs-on: henry-macbook
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          clean: true

      - id: parse-variables
        name: Parse variables
        run: node scripts/release/gcp.mjs parse-variables
        env:
          GCP_SA_KEY_BASE64: ${{needs.parse-inputs.outputs.GCP_SA_KEY_BASE64}}
          GCP_PRIVATE_SSH_KEY_BASE64: ${{needs.parse-inputs.outputs.GCP_PRIVATE_SSH_KEY_BASE64}}
          DOCKER_TAG_BASE64: ${{needs.parse-inputs.outputs.DOCKER_TAG_BASE64}}

      - name: Cache Yarn Unplugged
        uses: actions/cache@v3
        id: cache_yarn_unplugged
        env:
          cache-name: cache-yarn-unplugged
        with:
          path: ${{github.workspace}}/.yarn/unplugged
          key: ${{runner.os}}-${{env.cache-name}}-${{hashFiles('yarn.lock')}}

      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: yarn

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - id: auth
        name: Authenticate with Google Cloud
        uses: 'google-github-actions/auth@v1'
        with:
          token_format: access_token
          credentials_json: '${{env.GCP_CICD_SA_KEY}}'
          access_token_lifetime: 300s
        env:
          GCP_CICD_SA_KEY: ${{steps.parse-variables.outputs.GCP_SA_KEY}}

      - name: Login to Artifact Registry
        uses: docker/login-action@v2
        with:
          registry: ${{env.DOGU_GCP_REGION}}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{steps.auth.outputs.access_token}}

      - name: Push to Artifact Registry
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{steps.parse-variables.outputs.DOCKER_TAG}}
          file: dockerfile.gcp
          build-args: DOGU_RUN_TYPE=${{github.event.inputs.run_type}}
          target: ${{github.event.inputs.project_type}}

  release:
    needs:
      - parse-inputs
      - publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          sparse-checkout: |
            scripts/release
            docker-compose-gcp.yml
          clean: true

      - id: parse-variables
        name: Parse variables
        run: node scripts/release/gcp.mjs parse-variables
        env:
          GCP_SA_KEY_BASE64: ${{needs.parse-inputs.outputs.GCP_SA_KEY_BASE64}}
          GCP_PRIVATE_SSH_KEY_BASE64: ${{needs.parse-inputs.outputs.GCP_PRIVATE_SSH_KEY_BASE64}}
          DOCKER_TAG_BASE64: ${{needs.parse-inputs.outputs.DOCKER_TAG_BASE64}}

      - name: Authenticate with Google Cloud
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{steps.parse-variables.outputs.GCP_SA_KEY}}'

      - name: Rlease to Google Cloud Compute Engine
        uses: 'google-github-actions/ssh-compute@v0'
        with:
          instance_name: ${{github.event.inputs.project_type}}
          zone: ${{env.DOGU_GCP_REGION}}-a
          ssh_private_key: '${{steps.parse-variables.outputs.GCP_PRIVATE_SSH_KEY}}'
          command: |
            gcloud auth configure-docker ${{env.DOGU_GCP_REGION}}-docker.pkg.dev --quiet && \
            docker ps -qa | xargs -r docker rm -f && \
            docker system prune --volumes -a -f && \
            docker pull ${{steps.parse-variables.outputs.DOCKER_TAG}} && \
            DOGU_DOCKER_TAG=${{steps.parse-variables.outputs.DOCKER_TAG}} docker compose -f docker-compose-gcp.yml --verbose up -d ${{github.event.inputs.project_type}} && \
            docker image prune -a -f

  send-slack:
    runs-on: ubuntu-latest
    needs: release
    if: ${{always()}}

    steps:
      - name: Send Slack
        uses: dogu-team/slack@v1.0
        with:
          template: 'CD'
          slack-channel-id: 'C057ML9UH34'
          result-status: ${{needs.release.result}}
          ignore-notify: false
        env:
          SLACK_BOT_TOKEN: ${{secrets.SLACK_BOT_TOKEN}}
